(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9674],{2688:function(e,t,s){Promise.resolve().then(s.bind(s,226)),Promise.resolve().then(s.bind(s,912)),Promise.resolve().then(s.bind(s,1481))},226:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return c}});var n=s(7437),r=s(2265),a=s(3429),l=s(2828),o=s(7138);function i(){let{tokens:e}=(0,a.a)(),[t,s]=(0,r.useState)(!0),[i,c]=(0,r.useState)([]),[u,d]=(0,r.useState)(null),[h,g]=(0,r.useState)(null),[f,m]=(0,r.useState)(null),[x,v]=(0,r.useState)(""),[p,y]=(0,r.useState)(""),[b,w]=(0,r.useState)(null);(0,r.useEffect)(()=>{(null==e?void 0:e.key)&&j()},[e,x]),(0,r.useEffect)(()=>{b&&clearTimeout(b);let t=setTimeout(()=>{(null==e?void 0:e.key)&&j(1)},500);return w(t),()=>{t&&clearTimeout(t)}},[p]);let j=async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(null==e?void 0:e.key){s(!0),g(null);try{let s=await (0,l.AW)(e.key,t,void 0,x?"true"===x:void 0,p||void 0);c(s.results),d(s)}catch(e){var n,r;g((null===(r=e.response)||void 0===r?void 0:null===(n=r.data)||void 0===n?void 0:n.detail)||e.message||"Erreur lors du chargement")}finally{s(!1)}}},k=async t=>{if(null==e?void 0:e.key){m(t.id);try{t.is_active?await (0,l.b8)(t.id,e.key):await (0,l.Sp)(t.id,e.key),await j((null==u?void 0:u.current_page)||1)}catch(e){var s,n;g((null===(n=e.response)||void 0===n?void 0:null===(s=n.data)||void 0===s?void 0:s.detail)||e.message||"Erreur lors de la modification")}finally{m(null)}}},N=e=>(0,n.jsx)("span",{className:"px-2 py-1 text-xs font-semibold rounded-full ".concat(e?"bg-green-100 text-green-800":"bg-red-100 text-red-800"),children:e?"Actif":"Inactif"});return t&&!i.length?(0,n.jsx)("div",{className:"flex min-h-screen items-center justify-center",children:(0,n.jsx)("div",{className:"text-lg",children:"Chargement..."})}):(0,n.jsx)("div",{className:"h-full w-full bg-gray-50 py-8 px-4 sm:px-6 lg:px-8",children:(0,n.jsxs)("div",{className:"mx-auto w-full max-w-7xl",children:[(0,n.jsxs)("div",{className:"mb-6",children:[(0,n.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Gestion des utilisateurs"}),(0,n.jsx)("p",{className:"mt-2 text-sm text-gray-600",children:"G\xe9rez les comptes utilisateurs, activez/d\xe9sactivez les comptes et consultez l'historique des produits."})]}),(0,n.jsxs)("div",{className:"mb-6 flex gap-4 rounded-md bg-white p-4 shadow",children:[(0,n.jsx)("div",{className:"flex-1",children:(0,n.jsx)("input",{type:"text",placeholder:"Rechercher par email, nom d'utilisateur, pr\xe9nom, nom...",value:p,onChange:e=>y(e.target.value),className:"w-full rounded-md border-gray-300 px-3 py-2 text-sm"})}),(0,n.jsxs)("select",{value:x,onChange:e=>{v(e.target.value),j(1)},className:"rounded-md border-gray-300 px-3 py-2 text-sm",children:[(0,n.jsx)("option",{value:"",children:"Tous les statuts"}),(0,n.jsx)("option",{value:"true",children:"Actif"}),(0,n.jsx)("option",{value:"false",children:"Inactif"})]})]}),h&&(0,n.jsx)("div",{className:"mb-4 rounded-md bg-red-50 p-4 text-red-800",children:h}),0===i.length?(0,n.jsx)("div",{className:"bg-white p-12 text-center shadow rounded-lg",children:(0,n.jsx)("p",{className:"text-lg text-gray-500",children:"Aucun utilisateur trouv\xe9"})}):(0,n.jsx)("div",{className:"space-y-4",children:i.map(e=>(0,n.jsx)("div",{className:"overflow-hidden bg-white shadow rounded-lg",children:(0,n.jsx)("div",{className:"px-6 py-4",children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"text-lg font-medium text-gray-900",children:e.first_name||e.last_name?"".concat(e.first_name||""," ").concat(e.last_name||"").trim():e.username||e.email}),(0,n.jsx)("p",{className:"text-sm text-gray-500",children:e.email}),e.username&&(0,n.jsxs)("p",{className:"text-xs text-gray-400",children:["@",e.username]})]}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)("span",{className:"px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800",children:"Client"}),N(e.is_active)]})]}),(0,n.jsxs)("div",{className:"mt-2 flex gap-4 text-sm text-gray-600",children:[(0,n.jsxs)("span",{children:[(0,n.jsx)("strong",{children:e.products_count||0})," produit(s) cr\xe9\xe9(s)"]}),(0,n.jsxs)("span",{children:["Inscrit le ",new Date(e.date_joined).toLocaleDateString("fr-FR")]}),e.last_login&&(0,n.jsxs)("span",{children:["Derni\xe8re connexion: ",new Date(e.last_login).toLocaleDateString("fr-FR")]})]})]}),(0,n.jsxs)("div",{className:"ml-4 flex gap-2",children:[(0,n.jsx)(o.default,{href:"/admin/users/".concat(e.id),className:"rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700",children:"D\xe9tails"}),(0,n.jsx)("button",{onClick:()=>k(e),disabled:f===e.id||e.is_superuser,className:"rounded-md px-4 py-2 text-sm font-medium text-white ".concat(e.is_active?"bg-red-600 hover:bg-red-700":"bg-green-600 hover:bg-green-700"," disabled:opacity-50"),children:f===e.id?"...":e.is_active?"D\xe9sactiver":"Activer"})]})]})})},e.id))}),u&&u.total_pages>1&&(0,n.jsxs)("div",{className:"mt-6 flex items-center justify-between border-t border-gray-200 bg-white px-6 py-4 rounded-lg shadow",children:[(0,n.jsxs)("div",{className:"text-sm text-gray-700",children:["Page ",u.current_page," sur ",u.total_pages," (",u.count," ","utilisateur(s) au total)"]}),(0,n.jsxs)("div",{className:"flex gap-2",children:[u.previous_page&&(0,n.jsx)("button",{onClick:()=>j(u.previous_page),className:"rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50",children:"Pr\xe9c\xe9dent"}),u.next_page&&(0,n.jsx)("button",{onClick:()=>j(u.next_page),className:"rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50",children:"Suivant"})]})]})]})})}function c(){return(0,n.jsx)(i,{})}},3429:function(e,t,s){"use strict";s.d(t,{H:function(){return c},a:function(){return u}});var n=s(7437),r=s(2265),a=s(9988);let l=(0,r.createContext)(void 0),o="primini_auth";function i(e){if(!e){console.warn("getAuthHeader called with null tokens");return}if(e.access){let t={Authorization:"Bearer ".concat(e.access)};return console.log("Using Bearer token for auth"),t}if(e.key){let t={Authorization:"Token ".concat(e.key)};return console.log("Using Token for auth, token length:",e.key.length),t}console.warn("No valid token found in tokens object:",e)}function c(e){let{children:t}=e,[s,c]=function(){let[e,t]=(0,r.useState)(()=>{let e=window.localStorage.getItem(o);if(!e)return console.log("No stored auth tokens found"),null;try{var t;let s=JSON.parse(e);return console.log("Loaded tokens from localStorage:",{hasKey:!!s.key,hasAccess:!!s.access,keyLength:(null===(t=s.key)||void 0===t?void 0:t.length)||0}),s}catch(e){return console.warn("Failed to parse auth tokens",e),null}});return[e,(0,r.useCallback)(e=>{if(t(e),e){var s;console.log("Storing tokens to localStorage:",{hasKey:!!e.key,hasAccess:!!e.access,keyLength:(null===(s=e.key)||void 0===s?void 0:s.length)||0}),window.localStorage.setItem(o,JSON.stringify(e))}else console.log("Clearing tokens from localStorage"),window.localStorage.removeItem(o)},[])]}(),[u,d]=(0,r.useState)(null),[h,g]=(0,r.useState)(!0);(0,r.useEffect)(()=>{!async function(){if(g(!0),!(null==s?void 0:s.access)&&!(null==s?void 0:s.key)){d(null),g(!1);return}try{let e=i(s);console.log("Fetching user on mount/update with headers:",e);let t=await a.Z.get("/auth/user/",{headers:e});console.log("User fetched successfully:",JSON.stringify(t.data,null,2)),console.log("User role from API:",t.data.role);let n={...t.data,role:t.data.role||"visitor"};console.log("Setting user data:",JSON.stringify(n,null,2)),console.log("isAdmin will be:","admin"===n.role),d(n)}catch(s){var e,t,n;console.error("Failed to fetch user profile:",s),console.error("Error response:",null===(e=s.response)||void 0===e?void 0:e.data),console.error("Error status:",null===(t=s.response)||void 0===t?void 0:t.status),(null===(n=s.response)||void 0===n?void 0:n.status)===401&&(c(null),d(null))}finally{g(!1)}}()},[c,s]);let f=(0,r.useCallback)(async(e,t)=>{let s=await a.Z.post("/auth/login/",{email:e,password:t});console.log("Login response:",s.data),console.log("Login response keys:",Object.keys(s.data||{}));let n=s.data,r={key:n.key||n.token||n.token_key,access:n.access,refresh:n.refresh};if(!r.key&&!r.access)throw console.error("No token received in login response:",s.data),console.error("Response structure:",JSON.stringify(s.data,null,2)),Error("Aucun token re\xe7u lors de la connexion. R\xe9ponse: "+JSON.stringify(s.data));console.log("Token extracted successfully:",{hasKey:!!r.key,hasAccess:!!r.access,keyPreview:r.key?r.key.substring(0,10)+"...":"none"}),c(r);try{let e=i(r);console.log("Fetching user with headers:",e);let t=await a.Z.get("/auth/user/",{headers:e});console.log("User response:",JSON.stringify(t.data,null,2)),console.log("User role from API:",t.data.role);let s={...t.data,role:t.data.role||"visitor"};console.log("Setting user data:",JSON.stringify(s,null,2)),d(s)}catch(e){var l,o;throw console.error("Failed to fetch user profile after login:",e),console.error("Error response:",null===(l=e.response)||void 0===l?void 0:l.data),console.error("Error status:",null===(o=e.response)||void 0===o?void 0:o.status),e}},[c]),m=(0,r.useCallback)(async e=>{await a.Z.post("/auth/registration/",e)},[]),x=(0,r.useCallback)(()=>{c(null),d(null)},[c]),v=(0,r.useMemo)(()=>(null==u?void 0:u.role)==="admin",[u]),p=(0,r.useMemo)(()=>(null==u?void 0:u.role)==="client",[u]),y=(0,r.useMemo)(()=>(null==u?void 0:u.role)==="user",[u]),b=(0,r.useMemo)(()=>(null==u?void 0:u.role)==="visitor",[u]),w=(0,r.useMemo)(()=>({user:u,tokens:s,loading:h,isAdmin:v,isClient:p,isUser:y,isVisitor:b,login:f,register:m,logout:x}),[h,f,x,m,s,u,v,p,y,b]);return(0,n.jsx)(l.Provider,{value:w,children:t})}function u(){let e=(0,r.useContext)(l);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},9988:function(e,t,s){"use strict";let n=s(8472).Z.create({baseURL:"https://api.azyo6271.odns.fr/api",withCredentials:!1});t.Z=n},2828:function(e,t,s){"use strict";s.d(t,{AW:function(){return a},M_:function(){return l},Sp:function(){return i},b8:function(){return c},m6:function(){return o}});var n=s(9988);function r(e){return e?{Authorization:"Token ".concat(e)}:{}}async function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,s=(arguments.length>2&&arguments[2],arguments.length>3?arguments[3]:void 0),a=arguments.length>4?arguments[4]:void 0,l={page:t.toString()};return void 0!==s&&(l.is_active=s.toString()),a&&(l.search=a),(await n.Z.get("/users/",{headers:r(e),params:l})).data}async function l(e,t){return(await n.Z.get("/users/".concat(e,"/"),{headers:r(t)})).data}async function o(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,a=arguments.length>3?arguments[3]:void 0,l=arguments.length>4?arguments[4]:void 0,o={page:s.toString()};return a&&(o.approval_status=a),l&&(o.search=l),(await n.Z.get("/users/".concat(e,"/products/"),{headers:r(t),params:o})).data}async function i(e,t){return(await n.Z.post("/users/".concat(e,"/activate/"),{},{headers:r(t)})).data}async function c(e,t){return(await n.Z.post("/users/".concat(e,"/deactivate/"),{},{headers:r(t)})).data}},7138:function(e,t,s){"use strict";s.d(t,{default:function(){return r.a}});var n=s(231),r=s.n(n)},912:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"BailoutToCSR",{enumerable:!0,get:function(){return r}});let n=s(5592);function r(e){let{reason:t,children:s}=e;if("undefined"==typeof window)throw new n.BailoutToCSRError(t);return s}},1481:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"PreloadCss",{enumerable:!0,get:function(){return a}});let n=s(7437),r=s(8512);function a(e){let{moduleIds:t}=e;if("undefined"!=typeof window)return null;let s=(0,r.getExpectedRequestStore)("next/dynamic css"),a=[];if(s.reactLoadableManifest&&t){let e=s.reactLoadableManifest;for(let s of t){if(!e[s])continue;let t=e[s].files.filter(e=>e.endsWith(".css"));a.push(...t)}}return 0===a.length?null:(0,n.jsx)(n.Fragment,{children:a.map(e=>(0,n.jsx)("link",{precedence:"dynamic",rel:"stylesheet",href:s.assetPrefix+"/_next/"+encodeURI(e),as:"style"},e))})}}},function(e){e.O(0,[8472,231,2971,7023,1744],function(){return e(e.s=2688)}),_N_E=e.O()}]);